<script>
(() => {
  let chartPromise;

  function ensureChartJs() {
    if (!chartPromise) {
      chartPromise = new Promise((resolve) => {
        if (window.Chart) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.3.0/chart.umd.min.js';
        script.onload = () => resolve();
        script.onerror = () => resolve();
        document.head.appendChild(script);
      });
    }
    return chartPromise;
  }

  function runServer(method, ...args) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)[method](...args);
    });
  }

  function formatCurrency(value) {
    const number = Number(value) || 0;
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(number);
  }

  function renderDashboard(container, data) {
    if (!container) return;
    container.innerHTML = '';
    if (!data || !data.ok) {
      container.textContent = data && data.message ? data.message : 'Erro ao carregar o dashboard.';
      return;
    }

    const summarySection = document.createElement('div');
    summarySection.innerHTML = '<h4>Resumo geral</h4>';
    const summaryTable = document.createElement('table');
    summaryTable.className = 'dashboard-table';
    summaryTable.innerHTML = '<tr><th>Status</th><th>Quantidade</th><th>Valor Total</th></tr>';
    Object.keys(data.summaryStatus).forEach((status) => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${status}</td><td>${data.summaryStatus[status]}</td><td>${formatCurrency(data.summaryValues[status] || 0)}</td>`;
      summaryTable.appendChild(row);
    });
    summarySection.appendChild(summaryTable);
    container.appendChild(summarySection);

    const reasonsSection = document.createElement('div');
    reasonsSection.innerHTML = '<h4>Motivos de recusa</h4>';
    const reasonsCanvas = document.createElement('canvas');
    reasonsSection.appendChild(reasonsCanvas);
    container.appendChild(reasonsSection);
    const reasonsLabels = Object.keys(data.reasons || {});
    const reasonsValues = reasonsLabels.map((k) => data.reasons[k]);
    if (reasonsLabels.length) {
      renderChart(reasonsCanvas, 'pie', {
        labels: reasonsLabels,
        datasets: [{ data: reasonsValues }],
      }, { plugins: { legend: { position: 'right' } }, responsive: true, maintainAspectRatio: false });
    } else {
      reasonsSection.textContent = 'Sem recusas registradas.';
    }

    const dailySection = document.createElement('div');
    dailySection.innerHTML = '<h4>Uploads diários</h4>';
    const dailyCanvas = document.createElement('canvas');
    dailySection.appendChild(dailyCanvas);
    container.appendChild(dailySection);
    const dailyLabels = (data.dailyUploads || []).map((d) => d.date);
    const dailyCounts = (data.dailyUploads || []).map((d) => d.count);
    renderChart(dailyCanvas, 'bar', {
      labels: dailyLabels,
      datasets: [{ label: 'Notas importadas', data: dailyCounts }],
    }, { scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 7 } } } });

    const prodSection = document.createElement('div');
    prodSection.innerHTML = '<h4>Produtividade por usuário</h4>';
    const prodCanvas = document.createElement('canvas');
    prodSection.appendChild(prodCanvas);
    container.appendChild(prodSection);
    const prodUsers = (data.productivity?.created || []).map((u) => u.user);
    const prodCounts = (data.productivity?.created || []).map((u) => u.count);
    renderChart(prodCanvas, 'bar', {
      labels: prodUsers,
      datasets: [{ label: 'Notas criadas', data: prodCounts }],
    }, { scales: { x: { ticks: { autoSkip: false } } }, plugins: { legend: { display: false } } });

    const lastSection = document.createElement('div');
    lastSection.innerHTML = '<h4>Últimas notas</h4>';
    const lastTable = document.createElement('table');
    lastTable.className = 'dashboard-table';
    lastTable.innerHTML = '<tr><th>Data</th><th>Chave</th><th>Status</th><th>Valor</th><th>Criado por</th></tr>';
    (data.lastActivities || []).forEach((act) => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${(act.criadoEm || '').slice(0, 10)}</td>` +
                      `<td>${act.chave || ''}</td>` +
                      `<td>${act.status || ''}</td>` +
                      `<td>${formatCurrency(act.valor)}</td>` +
                      `<td>${act.criadoPor || ''}</td>`;
      lastTable.appendChild(row);
    });
    lastSection.appendChild(lastTable);
    container.appendChild(lastSection);
  }

  function renderPersonalDashboard(container, data) {
    if (!container) return;
    container.innerHTML = '';
    if (!data || !data.ok) {
      container.textContent = data && data.message ? data.message : 'Erro ao carregar seu dashboard.';
      return;
    }

    const summarySection = document.createElement('div');
    summarySection.innerHTML = '<h4>Meu resumo</h4>';
    const summaryTable = document.createElement('table');
    summaryTable.className = 'dashboard-table';
    summaryTable.innerHTML = '<tr><th>Status</th><th>Quantidade</th><th>Valor Total</th></tr>';
    Object.keys(data.summaryStatus).forEach((status) => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${status}</td><td>${data.summaryStatus[status]}</td><td>${formatCurrency(data.summaryValues[status] || 0)}</td>`;
      summaryTable.appendChild(row);
    });
    summarySection.appendChild(summaryTable);
    container.appendChild(summarySection);

    if (Object.keys(data.reasons || {}).length > 0) {
      const reasonsSection = document.createElement('div');
      reasonsSection.innerHTML = '<h4>Meus motivos de recusa</h4>';
      const reasonsCanvas = document.createElement('canvas');
      reasonsSection.appendChild(reasonsCanvas);
      container.appendChild(reasonsSection);
      renderChart(reasonsCanvas, 'pie', {
        labels: Object.keys(data.reasons),
        datasets: [{ data: Object.values(data.reasons) }],
      }, { plugins: { legend: { position: 'right' } }, responsive: true, maintainAspectRatio: false });
    }

    const lastSection = document.createElement('div');
    lastSection.innerHTML = '<h4>Minhas últimas notas</h4>';
    const lastTable = document.createElement('table');
    lastTable.className = 'dashboard-table';
    lastTable.innerHTML = '<tr><th>Data</th><th>Chave</th><th>Status</th><th>Valor</th></tr>';
    (data.lastActivities || []).forEach((act) => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${(act.criadoEm || '').slice(0, 10)}</td>` +
                      `<td>${act.chave || ''}</td>` +
                      `<td>${act.status || ''}</td>` +
                      `<td>${formatCurrency(act.valor)}</td>`;
      lastTable.appendChild(row);
    });
    lastSection.appendChild(lastTable);
    container.appendChild(lastSection);
  }

  function renderChart(canvas, type, data, options = {}) {
    if (!canvas) return;
    if (canvas.__chart) {
      canvas.__chart.destroy();
    }
    const ctx = canvas.getContext('2d');
    canvas.__chart = new Chart(ctx, { type, data, options });
  }

  async function loadDashboardsInternal() {
    const geralContainer = document.getElementById('dashboardContent');
    const pessoalContainer = document.getElementById('dashboardPessoalContent');
    if (!geralContainer || !pessoalContainer) return;

    const pin = sessionStorage.getItem('userPin') || '';
    if (!pin) {
      geralContainer.textContent = 'Faça login para ver o dashboard.';
      pessoalContainer.textContent = 'Faça login para ver o dashboard.';
      return;
    }

    geralContainer.textContent = 'Carregando...';
    pessoalContainer.textContent = 'Carregando...';

    try {
      await ensureChartJs();
      const [geralData, pessoalData] = await Promise.all([
        runServer('apiDashboardServer', pin),
        runServer('apiDashboardPessoalServer', pin)
      ]);
      renderDashboard(geralContainer, geralData);
      renderPersonalDashboard(pessoalContainer, pessoalData);
    } catch (err) {
      console.error('loadDashboards error', err);
      geralContainer.textContent = 'Falha ao carregar dashboard.';
      pessoalContainer.textContent = 'Falha ao carregar dashboard.';
    }
  }

  window.loadDashboards = function () {
    loadDashboardsInternal();
  };

  document.addEventListener('DOMContentLoaded', () => {
    if (sessionStorage.getItem('userPin')) {
      loadDashboardsInternal();
    }
  });
})();
</script>
